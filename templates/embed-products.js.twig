(function() {
    'use strict';

    const products = {{ products|raw }};
    const feedId = '{{ feedId }}';
    const feedName = "{{ feedName }}";
    const layout = "{{ layout|default('carousel') }}";
    const options = {{ layoutOptions|json_encode|raw }} || {};

    const currentScript = document.currentScript ||
        (function() {
            const scripts = document.getElementsByTagName('script');
            return scripts[scripts.length - 1];
        })();

    const widgetContainer = document.createElement('div');
    widgetContainer.id = 'heureka-widget-' + feedId + '-' + Date.now();
    widgetContainer.className = 'bnnr_prod_widget bnnr_layout_' + layout;
    currentScript.parentNode.insertBefore(widgetContainer, currentScript);

    const hexToRgba = (hex, alpha) => {
        if (!hex) return 'rgba(0,0,0,' + alpha + ')';
        hex = hex.replace('#', '');
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    };

    const formatPrice = (price, format) => {
        if (!price) return '';
        let numPrice = parseFloat(price.toString().replace(/\s/g, '').replace(',', '.'));
        if (isNaN(numPrice)) return price;

        if (format === 'no_decimals') {
            return Math.round(numPrice).toLocaleString('cs-CZ').replace(/\s/g, '&nbsp;');
        }

        const formatted = numPrice.toLocaleString('cs-CZ', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        if (format === 'dot') {
            return formatted.replace(',', '.').replace(/\s/g, '&nbsp;');
        }

        return formatted.replace(/\s/g, '&nbsp;');
    };

    // Shadow Logic
    const shadowEnabled = options.cardShadowEnabled !== false; // Default true
    const shadowColor = options.cardShadowColor || '#000000';
    const shadowBlur = options.cardShadowBlur !== undefined ? options.cardShadowBlur : 10;
    const shadowOpacity = options.cardShadowOpacity !== undefined ? options.cardShadowOpacity : 10; // 0-100 (reversed logic in UI handled in frontend)
    // Frontend saves "inverted" logic? No, in frontend "0% transparency = 100% opacity".
    // "100% transparency = 0% opacity".
    // In UI: "Průhlednost stínu (X%)". Value passed to backend is `cardShadowOpacity`.
    // Wait, in frontend I did `value={100 - cardShadowOpacity}` for display/slider, but state is `cardShadowOpacity`.
    // Default state 10. `100 - 10 = 90%` displayed? Or `10%`?
    // Let's check frontend again...
    // In frontend defaults: `const [cardShadowOpacity, setCardShadowOpacity] = useState(10);`
    // UI Label: `Průhlednost stínu ({100 - cardShadowOpacity}%)`
    // Slider Value: `100 - cardShadowOpacity`
    // onChange: `setCardShadowOpacity(100 - val)`
    // So if I set slider to 0 (Full Opacity), val=0, `setCardShadowOpacity(100)`. Backend gets 100.
    // If I set slider to 100 (Invisible), val=100, `setCardShadowOpacity(0)`. Backend gets 0.
    // So `cardShadowOpacity` IS the opacity/alpha value (0-100).
    // So `hexToRgba(shadowColor, shadowOpacity / 100)` is correct.

    // BUT wait, looking at my frontend code in Step 319:
    // `value={100 - cardShadowOpacity}`
    // `onChange={(e) => setCardShadowOpacity(100 - parseInt(e.target.value))}`
    // If I want 0% transparency (full visible), slider = 0. `setCardShadowOpacity(100 - 0) = 100`.
    // If I want 100% transparency (invisible), slider = 100. `setCardShadowOpacity(100 - 100) = 0`.
    // So stored value is Opacity (0-100).

    const shadowStyle = shadowEnabled
        ? `0 4px ${shadowBlur}px ${hexToRgba(shadowColor, shadowOpacity / 100)}`
        : 'none';

    const hoverShadowStyle = shadowEnabled
        ? `0 10px ${Math.max(15, shadowBlur + 5)}px ${hexToRgba(shadowColor, Math.max(0, (shadowOpacity / 100) - 0.05))}`
        : 'none';


    const styles = `
        .bnnr_prod_widget {
            width: 100%;
            margin: 32px auto;
            font-family: system-ui, -apple-system, sans-serif;
        }

        .bnnr_prod_widget h1,
        .bnnr_prod_widget h2,
        .bnnr_prod_widget h3,
        .bnnr_prod_widget p.bnnr_widget_title {
            text-align: ${options.widgetTitleAlign || 'center'};
            font-size: ${options.widgetTitleSize || '24px'};
            margin: 0 0 ${options.widgetTitleMarginBottom !== undefined ? options.widgetTitleMarginBottom : 32}px;
            font-family: ${options.widgetTitleFont || 'inherit'};
            font-weight: ${options.widgetTitleBold ? '700' : '400'};
            font-style: ${options.widgetTitleItalic ? 'italic' : 'normal'};
            color: ${options.widgetTitleColor || '#111827'};
            letter-spacing: -0.025em;
        }

        .bnnr_prod_card {
            background: ${options.cardBackgroundColor || '#ffffff'};
            border-radius: ${options.cardBorderRadius !== undefined ? options.cardBorderRadius : 16}px;
            padding: 20px;
            box-shadow: ${shadowStyle};
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }

        .bnnr_prod_card:hover {
            transform: translateY(-4px);
            box-shadow: ${hoverShadowStyle};
        }

        .bnnr_prod_card img {
            width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 16px;
            transition: transform 0.3s ease;
        }

        .bnnr_prod_card:hover img {
            transform: scale(1.05);
        }

        .bnnr_prod_title {
            font-size: ${options.productNameSize || '15px'};
            font-weight: ${options.productNameBold ? '700' : '400'};
            font-style: ${options.productNameItalic ? 'italic' : 'normal'};
            font-family: ${options.productNameFont || 'inherit'};
            color: ${options.productNameColor || '#374151'};
            margin-bottom: 12px;
            min-height: ${options.productNameFull ? 'auto' : '44px'};
            display: -webkit-box;
            -webkit-line-clamp: ${options.productNameFull ? 'unset' : '2'};
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
            flex-grow: 1;
        }

        .bnnr_prod_price {
            font-size: ${options.priceSize || '22px'};
            font-weight: ${options.priceBold ? '800' : '400'};
            font-style: ${options.priceItalic ? 'italic' : 'normal'};
            font-family: ${options.priceFont || 'inherit'};
            color: ${options.priceColor || '#059669'};
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .bnnr_buy_btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            background: ${options.buttonColor || '#2563eb'};
            color: ${options.buttonTextColor || 'white'};
            font-size: ${options.buttonFontSize || '14px'};
            font-weight: ${options.buttonBold ? '600' : '400'};
            font-style: ${options.buttonItalic ? 'italic' : 'normal'};
            font-family: ${options.buttonFont || 'inherit'};
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s;
            margin-top: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .bnnr_buy_btn:hover {
            filter: brightness(90%);
            transform: translateY(-1px);
        }

        /* Carousel Styles */
        .bnnr_layout_carousel .bnnr_car_wrapper {
            overflow: hidden;
            position: relative;
        }
        .bnnr_layout_carousel .bnnr_car_track {
            display: flex;
            gap: 24px;
            width: max-content;
            animation: heureka-scroll 40s linear infinite;
        }
        .bnnr_layout_carousel .bnnr_prod_card {
            min-width: 220px;
            max-width: 220px;
        }
        @keyframes heureka-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        /* Grid Styles */
        .bnnr_layout_grid .bnnr_grid_wrapper {
            display: grid;
            grid-template-columns: repeat(${options.gridColumns || 4}, 1fr);
            gap: 24px;
        }

        /* List Styles */
        .bnnr_layout_list .bnnr_list_wrapper {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .bnnr_layout_list .bnnr_prod_card {
            flex-direction: row;
            align-items: center;
            text-align: left;
            height: auto;
            max-width: 100%;
            padding: 16px 24px;
        }
        .bnnr_layout_list .bnnr_prod_card img {
            width: 80px;
            height: 80px;
            margin-bottom: 0;
            margin-right: 20px;
            flex-shrink: 0;
        }
        .bnnr_layout_list .bnnr_prod_title {
            margin-bottom: 0;
            margin-right: 24px;
            min-height: auto;
            -webkit-line-clamp: 2;
            font-size: 16px;
        }
        .bnnr_layout_list .bnnr_prod_price {
            margin-bottom: 0;
            margin-right: 24px;
            white-space: nowrap;
            margin-left: auto; /* Push price and button to the right */
            font-size: 18px;
        }
        .bnnr_layout_list .bnnr_buy_btn {
            margin-top: 0;
            width: auto;
            min-width: 140px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .bnnr_layout_carousel .bnnr_prod_card {
                min-width: 180px;
                max-width: 180px;
            }
            .bnnr_layout_carousel .bnnr_prod_card img {
                height: 120px;
            }
            .bnnr_layout_grid .bnnr_grid_wrapper {
                grid-template-columns: repeat(${options.mobileGridColumns || 1}, 1fr);
            }
            .bnnr_layout_list .bnnr_prod_card {
                flex-wrap: wrap;
                padding: 16px;
            }
            .bnnr_layout_list .bnnr_prod_card img {
                width: 60px;
                height: 60px;
                margin-right: 16px;
            }
            .bnnr_layout_list .bnnr_prod_title {
                font-size: 14px;
                margin-right: 0;
                width: calc(100% - 76px); /* Full width minus image and gap */
                margin-bottom: 12px;
            }
            .bnnr_layout_list .bnnr_prod_price {
                margin-left: 0;
                margin-right: auto;
                font-size: 18px;
            }
            .bnnr_layout_list .bnnr_buy_btn {
                width: auto;
                min-width: 120px;
                margin-left: 16px;
            }
        }
    `;

    if (!document.getElementById('heureka-widget-styles')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'heureka-widget-styles';
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
    }

    function renderWidget() {
        if (!products || products.length === 0) {
            widgetContainer.innerHTML = '<p style="text-align: center; color: #666;">Žádné produkty k zobrazení</p>';
            return;
        }

        let contentHTML = '';

        if (layout === 'carousel') {
            const duplicatedProducts = [...products, ...products];
            const trackHTML = duplicatedProducts.map(product => renderCard(product)).join('');
            contentHTML = `
                <div class="bnnr_car_wrapper">
                    <div class="bnnr_car_track">
                        ${trackHTML}
                    </div>
                </div>
            `;
        } else if (layout === 'grid') {
            const gridHTML = products.map(product => renderCard(product)).join('');
            contentHTML = `
                <div class="bnnr_grid_wrapper">
                    ${gridHTML}
                </div>
            `;
        } else if (layout === 'list') {
            const listHTML = products.map(product => renderCard(product)).join('');
            contentHTML = `
                <div class="bnnr_list_wrapper">
                    ${listHTML}
                </div>
            `;
        }

        const validTags = ['h1', 'h2', 'h3', 'p'];
        const titleTag = validTags.includes(options.widgetTitleTag) ? options.widgetTitleTag : 'h2';
        const titleClass = titleTag === 'p' ? ' class="bnnr_widget_title"' : '';

        widgetContainer.innerHTML = `
            ${options.widgetTitle ? '<' + titleTag + titleClass + '>' + options.widgetTitle + '</' + titleTag + '>' : ''}
            ${contentHTML}
        `;
    }

    function renderCard(product) {
        return `
            <div class="bnnr_prod_card">
                <img src="${product.imgUrl || '/placeholder.png'}" alt="${product.productName}" loading="lazy">
                <div class="bnnr_prod_title" title="${product.productName.replace(/"/g, '&quot;')}">${product.productName}</div>
                <div class="bnnr_prod_price">${formatPrice(product.priceVat, options.priceFormat || 'comma')} Kč</div>
                <a href="${product.url}" target="_blank" rel="noopener noreferrer" class="bnnr_buy_btn">
                    ${options.buttonText || 'Koupit'}
                </a>
            </div>
        `;
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderWidget);
    } else {
        renderWidget();
    }
})();
