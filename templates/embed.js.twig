(function() {
    'use strict';

    const logos = {{ attachments|raw }};
    const widgetId = '{{ widgetId }}';
    const widgetTitle = "{{ title }}";

    // Použij hodnoty z entity nebo default
    const imgHeight = '{{ imageSize ?: 64 }}px';
    const imgMaxWidth = '120px';
    const itemGap = '{{ gap ?: 32 }}px';
    const maskLeft = '128px';
    const maskRight = '200px';
    const bg = '#ffffff';
    const fg = '#171717';

    const currentScript = document.currentScript ||
        (function() {
            const scripts = document.getElementsByTagName('script');
            return scripts[scripts.length - 1];
        })();

    const widgetContainer = document.createElement('div');
    widgetContainer.id = 'widget-' + widgetId + '-' + Date.now();
    widgetContainer.className = 'bnnr_logo_widget';
    currentScript.parentNode.insertBefore(widgetContainer, currentScript);

    const styles = `
        :root {
            --bg: ${bg};
            --fg: ${fg};
            --item-gap: ${itemGap};
            --img-h: ${imgHeight};
            --img-max-w: ${imgMaxWidth};
            --mask-left: ${maskLeft};
            --mask-right: ${maskRight};
        }
        @media (prefers-color-scheme: dark){
            :root { --bg:#0a0a0a; --fg:#ededed; }
        }
        body{
            margin:0; padding:24px;
            background:var(--bg);
            color:var(--fg);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        .bnnr_logo_carousel{
            width:100%;
            margin: 0 auto;
            overflow:hidden;
            position: relative;
            mask-image: linear-gradient(to right, transparent 0, #000 var(--mask-left), #000 calc(100% - var(--mask-right)), transparent 100%);
            -webkit-mask-image: linear-gradient(to right, transparent 0, #000 var(--mask-left), #000 calc(100% - var(--mask-right)), transparent 100%);
        }
        .bnnr_logo_strip{
            display:flex;
            align-items:center;
            list-style:none;
            padding:0;
            margin:0;
            gap: var(--item-gap);
            width:max-content;
            animation: scroll var(--speed) linear infinite;
            padding-right: var(--item-gap);
        }
        .bnnr_logo_strip img{
            height:var(--img-h);
            max-width:var(--img-max-w);
            object-fit:contain;
            display:block;
            opacity:.85;
            transition: opacity .2s ease;
        }
        .bnnr_logo_strip a{
            text-decoration: none;
            display: inline-block;
        }
        .bnnr_logo_strip img:hover{ opacity:1; cursor: pointer; }
        .bnnr_logo_strip a:hover img{ opacity:1; }
        {% if pauseOnHover %}
        .bnnr_logo_carousel:hover .bnnr_logo_strip {
            animation-play-state: paused;
        }
        {% endif %}
        @keyframes scroll{
            from { transform: translateX(0); }
            to   { transform: translateX(-50%); }
        }
        @media (max-width:768px){
            :root{ --img-h: 48px; --item-gap: 24px; --speed: 20s; }
        }
        h2{
            text-align:center;
            font-size: clamp(1.125rem, 2vw, 1.5rem);
            margin: 0 0 12px;
            font-weight: 700;
        }
    `;

    if (!document.getElementById('widget-styles-' + widgetId)) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'widget-styles-' + widgetId;
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
    }

    function renderWidget() {
        if (!logos || logos.length === 0) {
            widgetContainer.innerHTML = '<p style="text-align: center; color: #666;">Žádná loga k zobrazení</p>';
            return;
        }

        const containerWidth = window.innerWidth;
        const estimatedLogoWidth = parseInt(imgMaxWidth) + parseInt(itemGap);
        const logosPerScreen = Math.ceil(containerWidth / estimatedLogoWidth);
        const totalLogosNeeded = Math.max(logosPerScreen * 3, logos.length * 2);

        let duplicatedLogos = [];
        const repetitions = Math.ceil(totalLogosNeeded / logos.length);

        for (let i = 0; i < repetitions; i++) {
            duplicatedLogos.push(...logos);
        }
        if (repetitions % 2 !== 0) duplicatedLogos.push(...logos);

        const trackHTML = duplicatedLogos.map(logo => {
            const imgTag = `<img src="${logo.url}" alt="${logo.alt || ''}" class="bnnr_logo_item" loading="lazy">`;

            if (logo.link) {
                return `<a href="${logo.link}" target="_blank" rel="noopener noreferrer" style="display: inline-block;">${imgTag}</a>`;
            }
            return imgTag;
        }).join('');

        // Calculate duration: (items scrolled * baseSpeed) / 10
        // We scroll half of the total items
        const itemsScrolled = duplicatedLogos.length / 2;
        const baseSpeed = {{ speed ?: 20 }};
        const duration = (itemsScrolled * baseSpeed) / 10;

        widgetContainer.style.setProperty('--speed', duration + 's');

        widgetContainer.innerHTML = `
            <h2>${widgetTitle}</h2>
            <div class="bnnr_logo_carousel">
                <ul class="bnnr_logo_strip">
                    ${trackHTML}
                </ul>
            </div>
        `;
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderWidget);
    } else {
        renderWidget();
    }

    window.addEventListener('resize', renderWidget);

})();
