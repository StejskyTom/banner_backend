(function() {
    'use strict';

    const widgetId = '{{ widget.id }}';
    const content = {{ content|json_encode|raw }};
    const title = '{{ widget.name|e('js') }}';

    let currentScript = document.currentScript;
    if (!currentScript) {
        const scripts = document.getElementsByTagName('script');
        currentScript = scripts[scripts.length - 1];
    }

    const container = document.createElement('div');
    container.id = 'article-widget-' + widgetId + '-' + Date.now();
    container.className = 'bnnr_article_wrapper';

    // Logic to determine where to insert the widget
    if (currentScript && currentScript.parentNode && currentScript.parentNode.tagName !== 'HEAD') {
        currentScript.parentNode.insertBefore(container, currentScript);
    } else {
        if (document.body) {
            document.body.appendChild(container);
        } else {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.appendChild(container);
            });
        }
    }

    // Styles
    const styles = `
        .bnnr_article_wrapper {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 100%;
            margin: 0 auto;
            color: #374151;
            line-height: 1.6;
            box-sizing: border-box;
        }
        .bnnr_article_title {
            text-align: center;
            color: #111827;
            font-size: 28px;
            margin-bottom: 32px;
            font-weight: 700;
        }
        .bnnr_block {
            margin-bottom: 24px;
        }
        .bnnr_text {
            font-size: 16px;
            color: #374151;
            margin: 0;
            display: block;
            width: auto;
            overflow: visible;
        }
        .bnnr_text p {
            margin: 0 0 8px 0;
        }
        .bnnr_text h1 { font-size: 2em; font-weight: bold; margin: 0 0 8px 0; }
        .bnnr_text h2 { font-size: 1.5em; font-weight: bold; margin: 0 0 8px 0; }
        .bnnr_text h3 { font-size: 1.17em; font-weight: bold; margin: 0 0 8px 0; }
        
        .bnnr_img_container {
            text-align: center;
        }
        .bnnr_img {
            border-radius: 8px;
            max-width: 100%;
            height: auto;
        }
        .bnnr_wrap_container {
            width: 100%;
            overflow: hidden;
        }
        .bnnr_wrap_img {
            border-radius: 8px;
            margin-bottom: 16px;
            max-width: 100%;
            height: auto;
        }
        .bnnr_float_left {
            float: left;
            margin-right: 24px;
        }
        .bnnr_float_right {
            float: right;
            margin-left: 24px;
        }
        .bnnr_banner {
            background: #f3f4f6;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #4f46e5;
        }
        .bnnr_banner_text {
            color: #111827;
            margin: 0;
            text-transform: uppercase;
            font-size: 18px;
            font-weight: 700;
        }
        .bnnr_product {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .bnnr_product_img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .bnnr_product_name {
            color: #111827;
            margin: 0 0 16px 0;
            font-size: 18px;
            font-size: 18px;
            font-weight: 600;
        }
        .bnnr_product_desc {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.4;
            margin: 0 0 16px 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .bnnr_product_btn {
            background: #4f46e5;
            color: white !important;
            padding: 10px 24px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .bnnr_product_btn:hover {
            background: #4338ca;
        }
        .bnnr_clearfix::after {
            content: "";
            clear: both;
            display: table;
        }
        
        @media(max-width: 768px) {
            .bnnr_wrap_img {
                float: none !important;
                width: 100% !important;
                margin: 0 0 16px 0 !important;
                display: block !important;
            }
        }
        .bnnr_author {
            display: flex !important;
            align-items: center !important;
            gap: 16px !important;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #f3f4f6;
            text-align: left;
        }
        .bnnr_author_img {
            width: 64px !important;
            height: 64px !important;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            flex-shrink: 0 !important;
            display: block;
            margin: 0;
        }
        .bnnr_author_placeholder {
            width: 64px !important;
            height: 64px !important;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            flex-shrink: 0 !important;
            margin: 0;
        }
        .bnnr_author_content {
            flex: 1;
            min-width: 0; /* Fix for text truncation in flex items */
        }
        .bnnr_author_name {
            font-weight: 700;
            color: #111827;
            font-size: 18px;
            margin: 0;
            line-height: 1.25;
        }
        .bnnr_author_title {
            color: #4f46e5;
            font-weight: 500;
            font-size: 14px;
            margin: 0 0 4px 0;
        }
        .bnnr_author_bio {
            color: #4b5563;
            font-size: 14px;
            margin: 0;
            line-height: 1.4;
        }
        .bnnr_table_container {
            overflow-x: auto;
        }
        .bnnr_table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
        }
        .bnnr_table th, .bnnr_table td {
            padding: 12px 16px;
        }
        .bnnr_table th {
            font-weight: 600;
        }
    `;

    if (!document.getElementById('bnnr-article-styles-v4')) {
        const styleSheet = document.createElement('style');
        styleSheet.id = 'bnnr-article-styles-v4';
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);
    }

    // Render Blocks
    let html = `<div class="bnnr_article_inner">`;
    // html += `<h1 class="bnnr_article_title">${title}</h1>`; // Option to hide title in embed

    content.forEach(block => {
        const margin = `margin-bottom: ${block.margin !== undefined ? block.margin : 24}px;`;
        
        if (block.type === 'text') {
            const align = block.align ? `text-align: ${block.align};` : '';
            
            // Fallback for old content: replace \n with <br> if no HTML tags found? 
            // Or just output content. ContentEditable usually puts <div> or <p>.
            // If it's old plain text, it will just be text.
            let content = block.content || '';
            if (!content.includes('<') && content.includes('\n')) {
                 content = content.replace(/\n/g, '<br>');
            }
            
            html += `<div class="bnnr_text" style="${margin} ${align}">${content}</div>`;
        } 
        else if (block.type === 'image') {
            const align = block.align ? `text-align: ${block.align};` : '';
            html += `<div class="bnnr_img_container" style="${margin} ${align}">
                <img src="${block.url}" style="width: ${block.width}%; display: inline-block;" class="bnnr_img" alt="">
            </div>`;
        }
        else if (block.type === 'wrap') {
            const floatClass = block.imgPos === 'left' ? 'bnnr_float_left' : 'bnnr_float_right';
            
            let content = block.content || block.text || '';
             if (!content.includes('<') && content.includes('\n')) {
                 content = content.replace(/\n/g, '<br>');
            }

            html += `<div class="bnnr_wrap_container bnnr_clearfix" style="${margin}">
                ${block.imgUrl ? `<img src="${block.imgUrl}" class="bnnr_wrap_img ${floatClass}" style="width: ${block.imgWidth}%" alt="">` : ''}
                <div class="bnnr_text">${content}</div>
            </div>`;
        }
        else if (block.type === 'banner') {
            html += `<div class="bnnr_banner" style="${margin}">
                <h2 class="bnnr_banner_text">${block.content}</h2>
            </div>`;
        }
        else if (block.type === 'product') {
            html += `<div class="bnnr_product" style="${margin}">
                ${block.imgUrl ? `<img src="${block.imgUrl}" class="bnnr_product_img" alt="">` : ''}
                <h3 class="bnnr_product_name">${block.name}</h3>
                ${block.description ? `<p class="bnnr_product_desc">${block.description}</p>` : ''}
                ${block.link ? `<a href="${block.link}" target="_blank" class="bnnr_product_btn" style="background-color: ${block.btnColor || '#4f46e5'}">Koupit</a>` : ''}
            </div>`;
        }
        else if (block.type === 'author') {
            html += `<div class="bnnr_author" style="${margin}">
                ${block.authorPhotoUrl ? 
                    `<img src="${block.authorPhotoUrl}" class="bnnr_author_img" alt="${block.authorName}">` : 
                    `<div class="bnnr_author_placeholder"><svg style="width: 40px; height: 40px;" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /></svg></div>`
                }
                <div class="bnnr_author_content">
                    <h3 class="bnnr_author_name">${block.authorName || 'Jm√©no autora'}</h3>
                    ${block.authorTitle ? `<p class="bnnr_author_title">${block.authorTitle}</p>` : ''}
                    ${block.authorBio ? `<p class="bnnr_author_bio">${block.authorBio}</p>` : ''}
                </div>
            </div>`;
        }
        else if (block.type === 'table') {
            const borderColor = '#e5e7eb';
            const borderStyle = block.borderStyle || 'full';
            const outerBorder = block.outerBorder !== false;
            const width = block.width || 100;
            const textAlign = block.textAlign || 'left';
            const radius = block.borderRadius !== undefined ? block.borderRadius : 8;
            
            const tableStyle = `
                width: ${width}%;
                text-align: ${textAlign};
                border: ${outerBorder ? `1px solid ${borderColor}` : 'none'};
                border-radius: ${radius}px;
                border-collapse: separate;
                border-spacing: 0;
            `;
            
            let tableHtml = `<div class="bnnr_table_container" style="${margin}">
                <table class="bnnr_table" style="${tableStyle}" cellspacing="0" cellpadding="0">
                    <thead>
                        <tr>`;
            
            (block.header || []).forEach((head, i) => {
                const borderBottom = borderStyle !== 'none' ? `border-bottom: 1px solid ${borderColor};` : '';
                const borderRight = borderStyle === 'full' && i < (block.header.length - 1) ? `border-right: 1px solid ${borderColor};` : '';
                tableHtml += `<th style="background: ${block.headerBgColor || '#f3f4f6'}; color: ${block.headerTextColor || '#111827'}; ${borderBottom} ${borderRight}">${head}</th>`;
            });
            
            tableHtml += `</tr></thead><tbody>`;
            
            (block.data || []).forEach((row, rowIndex) => {
                tableHtml += `<tr>`;
                row.forEach((cell, colIndex) => {
                    const borderBottom = borderStyle !== 'none' && rowIndex < (block.data.length - 1) ? `border-bottom: 1px solid ${borderColor};` : '';
                    const borderRight = borderStyle === 'full' && colIndex < (row.length - 1) ? `border-right: 1px solid ${borderColor};` : '';
                    tableHtml += `<td style="${borderBottom} ${borderRight}">${cell}</td>`;
                });
                tableHtml += `</tr>`;
            });
            
            tableHtml += `</tbody></table></div>`;
            html += tableHtml;
        }
    });

    html += `</div>`; // End inner
    container.innerHTML = html;

})();
