(function() {
    const widgetId = 'author-widget-{{ widget.id }}';
    {% set s = widget.settings ?? {} %}
    
    // Create container
    const container = document.createElement('div');
    container.id = widgetId;
    container.style.fontFamily = 'system-ui, -apple-system, sans-serif';
    container.style.maxWidth = '600px';
    container.style.margin = '40px auto';
    container.style.padding = '30px';
    container.style.backgroundColor = '{{ widget.backgroundColor|default("#ffffff") }}';
    container.style.borderRadius = '{{ widget.borderRadius|default(16) }}px';
    {% if s.borderEnabled|default(false) %}
    container.style.border = '{{ s.borderWidth|default(1) }}px solid {{ s.borderColor|default("#e5e7eb") }}';
    {% else %}
    container.style.border = 'none';
    {% endif %}
    container.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
    container.style.textAlign = 'center';

    // Create styles
    const style = document.createElement('style');
    style.textContent = `
        #${widgetId} .bnnr_auth_photo {
            width: {{ s.photoSize|default(128) }}px;
            height: {{ s.photoSize|default(128) }}px;
            border-radius: {{ s.photoRadius|default(50) }}%;
            object-fit: cover;
            margin: 0 auto {{ s.photoMarginBottom|default(20) }}px auto;
            border: {{ s.photoBorderWidth|default(4) }}px solid {{ s.photoBorderColor|default('#f3f4f6') }};
            display: block;
            flex-shrink: 0;
            {% if s.photoShadow|default(false) %}
            box-shadow: 0 {{ ((s.photoShadowBlur|default(12)) / 3)|round }}px {{ s.photoShadowBlur|default(12) }}px rgba(0,0,0,{{ (s.photoShadowOpacity|default(25)) / 100 }});
            {% endif %}
        }
        #${widgetId} .bnnr_auth_name {
            font-size: {{ s.nameSize|default('24px') }};
            font-weight: {{ s.nameBold is defined and s.nameBold == false ? 'normal' : '700' }};
            font-style: {{ s.nameItalic|default(false) ? 'italic' : 'normal' }};
            font-family: {{ s.nameFont|default('sans-serif') }};
            text-align: {{ s.nameAlign|default('center') }};
            color: {{ s.nameColor|default(widget.nameColor|default('#111827')) }};
            margin: 0 0 {{ s.nameMarginBottom|default(8) }}px 0;
        }
        #${widgetId} .bnnr_auth_title {
            font-size: {{ s.positionSize|default('14px') }};
            font-weight: {{ s.positionBold|default(false) ? 'bold' : '500' }};
            font-style: {{ s.positionItalic|default(false) ? 'italic' : 'normal' }};
            font-family: {{ s.positionFont|default('sans-serif') }};
            text-align: {{ s.positionAlign|default('center') }};
            color: {{ s.positionColor|default(widget.titleColor|default('#4f46e5')) }};
            margin: 0 0 {{ s.positionMarginBottom|default(20) }}px 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        #${widgetId} .bnnr_auth_bio {
            font-size: {{ s.bioSize|default('16px') }};
            font-weight: {{ s.bioBold|default(false) ? 'bold' : 'normal' }};
            font-style: {{ s.bioItalic|default(false) ? 'italic' : 'normal' }};
            font-family: {{ s.bioFont|default('sans-serif') }};
            text-align: {{ s.bioAlign|default('center') }};
            line-height: 1.6;
            color: {{ s.bioColor|default(widget.bioColor|default('#4b5563')) }};
            margin: 0 0 {{ s.bioMarginBottom|default(0) }}px 0;
        }

        /* Side-by-side Layout */
        #${widgetId}.bnnr_layout_side {
            display: flex;
            align-items: flex-start;
            text-align: left;
            gap: 30px;
        }
        #${widgetId}.bnnr_layout_side .bnnr_auth_photo {
            margin: 0;
        }
        #${widgetId}.bnnr_layout_side .bnnr_auth_content {
            flex: 1;
        }
        #${widgetId}.bnnr_layout_side .bnnr_auth_name {
            text-align: {{ s.nameAlign|default('left') }};
        }
        #${widgetId}.bnnr_layout_side .bnnr_auth_title {
            text-align: {{ s.positionAlign|default('left') }};
        }
        #${widgetId}.bnnr_layout_side .bnnr_auth_bio {
            text-align: {{ s.bioAlign|default('left') }};
        }
        
        @media (max-width: 600px) {
            #${widgetId}.bnnr_layout_side {
                flex-direction: column;
                text-align: center;
            }
            #${widgetId}.bnnr_layout_side .bnnr_auth_photo {
                margin: 0 auto 20px auto;
            }
        }
    `;
    document.head.appendChild(style);

    {% set nameTag = s.nameTag|default('h3') %}
    {% set positionTag = s.positionTag|default('div') %}
    {% set bioTag = s.bioTag|default('p') %}

    // Content
    let contentHtml = '';
    const layout = '{{ widget.layout }}';
    
    if (layout === 'side-by-side') {
        container.classList.add('bnnr_layout_side');
        
        {% if widget.authorPhotoUrl %}
        contentHtml += `<img src="{{ widget.authorPhotoUrl }}" alt="{{ widget.authorName|e('html_attr') }}" class="bnnr_auth_photo">`;
        {% endif %}
        
        contentHtml += '<div class="bnnr_auth_content">';
        {% if widget.authorName %}
        contentHtml += `<{{ nameTag }} class="bnnr_auth_name">{{ widget.authorName|e('html') }}</{{ nameTag }}>`;
        {% endif %}
        
        {% if widget.authorTitle %}
        contentHtml += `<{{ positionTag }} class="bnnr_auth_title">{{ widget.authorTitle|e('html') }}</{{ positionTag }}>`;
        {% endif %}
        
        {% if widget.authorBio %}
        contentHtml += `<{{ bioTag }} class="bnnr_auth_bio">{{ widget.authorBio|nl2br|e('js') }}</{{ bioTag }}>`;
        {% endif %}
        contentHtml += '</div>';
        
    } else {
        // Centered (Default)
        {% if widget.authorPhotoUrl %}
        contentHtml += `<img src="{{ widget.authorPhotoUrl }}" alt="{{ widget.authorName|e('html_attr') }}" class="bnnr_auth_photo">`;
        {% endif %}
        
        {% if widget.authorName %}
        contentHtml += `<{{ nameTag }} class="bnnr_auth_name">{{ widget.authorName|e('html') }}</{{ nameTag }}>`;
        {% endif %}
        
        {% if widget.authorTitle %}
        contentHtml += `<{{ positionTag }} class="bnnr_auth_title">{{ widget.authorTitle|e('html') }}</{{ positionTag }}>`;
        {% endif %}
        
        {% if widget.authorBio %}
        contentHtml += `<{{ bioTag }} class="bnnr_auth_bio">{{ widget.authorBio|nl2br|e('js') }}</{{ bioTag }}>`;
        {% endif %}
    }

    container.innerHTML = contentHtml;

    // JSON-LD Structured Data
    const jsonLd = {
        "@context": "https://schema.org",
        "@type": "Person",
        "name": "{{ widget.authorName|e('js') }}",
        "jobTitle": "{{ widget.authorTitle|e('js') }}",
        "description": "{{ widget.authorBio|e('js') }}",
        "image": "{{ widget.authorPhotoUrl|e('js') }}"
    };

    const script = document.createElement('script');
    script.type = 'application/ld+json';
    script.text = JSON.stringify(jsonLd);
    document.head.appendChild(script);

    // Find script tag to insert after
    const scripts = document.getElementsByTagName('script');
    const currentScript = scripts[scripts.length - 1];
    currentScript.parentNode.insertBefore(container, currentScript.nextSibling);

    // Track View
    (function() {
        try {
            fetch('{{ app.request.schemeAndHttpHost }}/api/widget/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    widgetId: '{{ widget.id }}', 
                    widgetType: 'author' 
                }),
                keepalive: true,
                credentials: 'omit'
            }).catch(function() {});
        } catch (e) {}
    })();
})();
